name: CI/CD Pipeline

on:
  # main/developìœ¼ë¡œ ê°€ëŠ” PRì—ì„œëŠ” ë¹Œë“œ í…ŒìŠ¤íŠ¸ë§Œ
  pull_request:
    branches: [main, develop]

  # main/develop ë¸Œëœì¹˜ì— í‘¸ì‹œë˜ë©´ ë¹Œë“œ + ë°°í¬
  push:
    branches: [main, develop]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'adopt'
          java-version: '17'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean -x test build

      - name: Rename JAR for deployment
        run: cp build/libs/cherrydan-0.0.1-SNAPSHOT.jar app.jar

      # main ë˜ëŠ” develop ë¸Œëœì¹˜ í‘¸ì‹œì¼ ë•Œë§Œ ë°°í¬
      - name: Deploy to EC2
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          echo "===== JAR íŒŒì¼ EC2ë¡œ ë°°í¬ ì¤‘... ====="
          scp -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i private_key.pem \
            app.jar ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/
          
          ssh -o ConnectTimeout=10 -o BatchMode=yes -o StrictHostKeyChecking=no -i private_key.pem \
            ec2-user@${{ secrets.EC2_HOST }} << 'EOL'
          
            echo "===== ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ì§€ ====="
            if pgrep -f "app.jar" > /dev/null; then
              echo "ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¤‘ì§€í•©ë‹ˆë‹¤..."
              pkill -f "app.jar"
              sleep 3
          
              if pgrep -f "app.jar" > /dev/null; then
                echo "ê°•ì œ ì¢…ë£Œí•©ë‹ˆë‹¤..."
                pkill -9 -f "app.jar"
                sleep 2
              fi
              echo "ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—†ìŠµë‹ˆë‹¤."
            fi
          
            echo "===== ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ====="
            nohup java -jar app.jar > app.log 2>&1 &
          
            sleep 5
          
            echo "===== ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸ ====="
            if pgrep -f "app.jar" > /dev/null; then
              echo "ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
              echo "í”„ë¡œì„¸ìŠ¤ ID: $(pgrep -f 'app.jar')"
          
              # í¬íŠ¸ í™•ì¸
              if ss -tlnp | grep :8080 > /dev/null 2>&1; then
                echo "í¬íŠ¸ 8080ì´ ì •ìƒì ìœ¼ë¡œ ì—´ë ¤ìˆìŠµë‹ˆë‹¤."
              else
                echo "í¬íŠ¸ 8080 í™•ì¸ í•„ìš” (ì‹œì‘ ì¤‘ì¼ ìˆ˜ ìˆìŒ)"
              fi
          
              echo "=== ìµœê·¼ ë¡œê·¸ ====="
              tail -n 5 app.log
            else
              echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
              echo "=== ì—ëŸ¬ ë¡œê·¸ ====="
              tail -n 10 app.log
              exit 1
            fi
          echo "===== ë°°í¬ ì™„ë£Œ ====="  # ì¶”ê°€ í•„ìš”
          EOL  # ì´ ë¶€ë¶„ì´ ëˆ„ë½ë¨!
  
          # í‚¤ íŒŒì¼ ì‚­ì œë„ ì¶”ê°€í•˜ëŠ” ê²Œ ì¢‹ìŒ
          rm -f private_key.pem
          echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"